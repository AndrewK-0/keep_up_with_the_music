let artistsData=[],isAuthenticated=!1;async function checkAuthStatus(){try{const t=await fetch("/api/auth/spotify/status");if(401===t.status)return isAuthenticated=!1,updateAuthUI(),showSessionExpired(),!1;const e=await t.json();return isAuthenticated=e.authenticated,updateAuthUI(),e.authenticated}catch(t){return console.error("Error checking auth status:",t),!1}}function updateAuthUI(){const t=document.getElementById("spotifyLoginBtn"),e=document.getElementById("spotifyLogoutBtn");isAuthenticated?(t.style.display="none",e.style.display="block"):(t.style.display="block",e.style.display="none")}function handleLogin(){window.location.href="/auth/spotify"}async function handleLogout(){try{const t=await fetch("/api/auth/spotify/logout",{method:"POST"});(await t.json()).success&&(isAuthenticated=!1,updateAuthUI(),loadArtists())}catch(t){console.error("Error logging out:",t)}}async function loadArtists(){try{showLoading();const t=await fetch("/api/artists"),e=await t.json();e.success?(artistsData=e.artists,displayArtists(artistsData,e.source)):showError("Failed to load artists")}catch(t){console.error("Error loading artists:",t),showError("Error connecting to server")}}function displayArtists(t,e="global"){const s=document.getElementById("artistList");if(!t||0===t.length)return void(s.innerHTML='<p class="no-data">No artists found</p>');const n="personal"===e?"üéß Your Top Artists":"üåç Global Top 50";s.innerHTML=`\n    <div class="list-header">\n      <h2>${n}</h2>\n    </div>\n    ${t.map(t=>`\n      <div class="artist-card" data-artist-id="${t.id}">\n        <div class="artist-card-image">\n          ${t.images&&t.images.length>0?`<img src="${t.images[t.images.length-1].url}" alt="${t.name}">`:`<div class="no-image">${t.name.charAt(0)}</div>`}\n        </div>\n        <div class="artist-card-content">\n          <h3 class="artist-card-name">${t.name}</h3>\n          <p class="artist-card-genre">${t.genres&&t.genres.length>0?t.genres.slice(0,2).join(", "):"Artist"}</p>\n          <div class="artist-stats">\n            <span>‚≠ê ${t.popularity||"N/A"}</span>\n            ${t.followers?`<span>üë• ${formatNumber(t.followers.total||t.followers)}</span>`:""}\n          </div>\n        </div>\n      </div>\n    `).join("")}\n  `,document.querySelectorAll(".artist-card").forEach(t=>{t.addEventListener("click",()=>{selectArtist(t.dataset.artistId)})})}async function selectArtist(t){try{document.querySelectorAll(".artist-card").forEach(t=>{t.classList.remove("active")});const e=document.querySelector(`[data-artist-id="${t}"]`);e&&e.classList.add("active");const s=document.getElementById("artistDetails");s.classList.add("active"),s.innerHTML='<div class="loading">Loading artist details...</div>';const n=document.getElementById("artistList");window.innerWidth<=768&&n.classList.add("hidden");const a=await fetch(`/api/artists/${t}`),i=await a.json();i.success?displayArtistDetails(i.artist,i.topTracks):s.innerHTML='<div class="error">Failed to load artist details</div>'}catch(t){console.error("Error loading artist details:",t),document.getElementById("artistDetails").innerHTML='<div class="error">Error loading artist details</div>'}}function displayArtistDetails(t,e){const s=document.getElementById("artistDetails"),n=t.images&&t.images.length>0?t.images[0].url:"";s.innerHTML=`\n    <button class="back-button" id="backButton">‚Üê Back to Artists</button>\n    \n    <div class="artist-header">\n      <div class="artist-header-content">\n        ${n?`<img src="${n}" alt="${t.name}" class="artist-header-image">`:`<div class="artist-header-placeholder">${t.name.charAt(0)}</div>`}\n        <div class="artist-header-info">\n          <h2>${t.name}</h2>\n          <div class="artist-meta">\n            <div class="meta-item">\n              <strong>${formatNumber(t.followers)}</strong>\n              <span>Followers</span>\n            </div>\n            <div class="meta-item">\n              <strong>${t.popularity}</strong>\n              <span>Popularity</span>\n            </div>\n          </div>\n          ${t.genres&&t.genres.length>0?`\n            <div class="artist-genre-tags">\n              ${t.genres.map(t=>`<span class="artist-genre-tag">${t}</span>`).join("")}\n            </div>\n          `:""}\n          <a href="${t.spotify_url}" target="_blank" rel="noopener noreferrer" class="spotify-link">\n            Open in Spotify ‚Üí\n          </a>\n        </div>\n      </div>\n    </div>\n    \n    ${e&&e.length>0?`\n      <div class="detail-section">\n        <h3>Top Tracks</h3>\n        <div class="track-list">\n          ${e.map((t,e)=>`\n            <div class="track-item">\n              <span class="track-number">${e+1}</span>\n              <div class="track-info">\n                <div class="track-name">${t.name}</div>\n                <div class="track-album">${t.album}</div>\n              </div>\n              <a href="${t.spotify_url}" target="_blank" rel="noopener noreferrer" class="track-play">\n                ‚ñ∂\n              </a>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `:""}\n  `;const a=document.getElementById("backButton");a&&a.addEventListener("click",goBackToList)}function goBackToList(){const t=document.getElementById("artistList"),e=document.getElementById("artistDetails");t.classList.remove("hidden"),e.classList.remove("active"),document.querySelectorAll(".artist-card").forEach(t=>{t.classList.remove("active")})}function showLoading(){document.getElementById("artistList").innerHTML='\n    <div class="loading-container">\n      <div class="loading-spinner"></div>\n      <p>Loading artists...</p>\n    </div>\n  '}function showError(t){document.getElementById("artistList").innerHTML=`\n    <div class="error-container">\n      <p class="error-message">${t}</p>\n      <button onclick="loadArtists()" class="retry-button">Retry</button>\n    </div>\n  `}function formatNumber(t){return t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(1)+"K":t.toString()}function checkForAuthMessages(){const t=new URLSearchParams(window.location.search),e=t.get("error"),s=t.get("auth");if(e){let t="Authentication failed";"spotify_auth_failed"===e?t="Spotify authentication failed. Please try again.":"invalid_state"===e?t="Invalid authentication state. Please try again.":"token_exchange_failed"===e&&(t="Failed to exchange token. Please try again."),console.error(t),window.history.replaceState({},document.title,"/")}"success"===s&&(console.log("Successfully authenticated!"),window.history.replaceState({},document.title,"/"))}function showSessionExpired(t="Your session expired. You‚Äôve been signed out."){const e=document.createElement("div");e.className="session-expired-banner",e.textContent=t,document.body.prepend(e),setTimeout(()=>e.remove(),5e3)}async function loadArtists(){try{showLoading();const t=await fetch("/api/artists");if(401===t.status)return isAuthenticated=!1,updateAuthUI(),void showSessionExpired();const e=await t.json();e.success?(artistsData=e.artists,displayArtists(artistsData,e.source)):showError("Failed to load artists")}catch(t){console.error("Error loading artists:",t),showError("Error connecting to server")}}document.addEventListener("DOMContentLoaded",async()=>{checkForAuthMessages(),await checkAuthStatus();const t=document.getElementById("spotifyLoginBtn"),e=document.getElementById("spotifyLogoutBtn");t&&t.addEventListener("click",handleLogin),e&&e.addEventListener("click",handleLogout),loadArtists()});