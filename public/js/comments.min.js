const form=document.getElementById("commentForm"),titleInput=document.getElementById("title"),bodyInput=document.getElementById("body"),commentsContainer=document.getElementById("comments"),loginBtn=document.getElementById("loginBtn"),logoutBtn=document.getElementById("logoutBtn"),authStatus=document.getElementById("authStatus"),modal=document.getElementById("authModal"),modalTitle=document.getElementById("authModalTitle"),authUsername=document.getElementById("authUsername"),authPassword=document.getElementById("authPassword"),authSubmitBtn=document.getElementById("authSubmitBtn"),authSwitchBtn=document.getElementById("authSwitchBtn"),authError=document.getElementById("authError"),authCloseBtn=document.getElementById("authCloseBtn");let isAuthenticated=!1,authMode="login",currentUser=null;async function checkAuth(){try{const t=await fetch("/api/auth/status");if(401===t.status)return void handleSessionExpired();if(!t.ok)return void console.error("Auth check failed with status:",t.status);const e=await t.json();isAuthenticated=!!e.authenticated,currentUser=e.user?.username||null,isAuthenticated?(authStatus.textContent=`Signed in as ${currentUser}`,loginBtn.hidden=!0,logoutBtn.hidden=!1):(authStatus.textContent="Sign in to post comments",loginBtn.hidden=!1,logoutBtn.hidden=!0),updateCommentFormState(),await loadComments()}catch(t){console.error("Auth check failed",t),isAuthenticated=!1,currentUser=null,updateCommentFormState()}}function updateCommentFormState(){const t=!isAuthenticated;titleInput.disabled=t,bodyInput.disabled=t,t?(titleInput.placeholder="Sign in to post comments",bodyInput.placeholder="Sign in to post comments"):(titleInput.placeholder="Comment title",bodyInput.placeholder="Share your thoughts...")}function openAuthModal(t="login"){authMode=t,modal.classList.remove("hidden"),authError.textContent="",authError.style.color="#ef4444",modalTitle.textContent="login"===t?"Sign In":"Create Account",authSwitchBtn.textContent="login"===t?"Need an account? Sign up":"Already have an account? Sign in",authSubmitBtn.textContent="login"===t?"Sign In":"Sign Up"}function closeAuthModal(){modal.classList.add("hidden"),authUsername.value="",authPassword.value="",authError.textContent=""}async function loadComments(){commentsContainer.textContent="Loading comments...";try{const t=await fetch("/api/comments");if(!t.ok)throw new Error(`Failed to load comments: ${t.status}`);const e=await t.json();if(commentsContainer.innerHTML="",!e.length)return void(commentsContainer.textContent="No comments yet. Be the first to share your thoughts!");e.forEach(renderComment)}catch(t){console.error("Load comments error:",t),commentsContainer.textContent="Failed to load comments. Please refresh the page."}}function renderComment(t){const e=document.createElement("div");e.className="comment";const n=t=>{const e=document.createElement("div");return e.textContent=t,e.innerHTML},o=n(t.title),a=n(t.body),r=n(t.username),i=new Date(t.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});if(e.innerHTML=`\n    <h4>${o}</h4>\n    <small>${r} â€¢ ${i}</small>\n    <p>${a}</p>\n  `,isAuthenticated&&t.username===currentUser){const n=document.createElement("button");n.textContent="Delete",n.className="comment-delete",n.onclick=async()=>{if(confirm("Delete your comment?")){n.disabled=!0,n.textContent="Deleting...";try{const e=await fetch(`/api/comments/${t.id}`,{method:"DELETE"});if(401===e.status)return void handleSessionExpired();if(!e.ok){const t=await e.json();return void alert(t.error||"Failed to delete comment")}await loadComments()}catch(t){console.error("Delete error:",t),alert("Network error. Please try again."),n.disabled=!1,n.textContent="Delete"}}},e.appendChild(n)}commentsContainer.appendChild(e)}function handleSessionExpired(t="Your session expired. Please sign in again."){isAuthenticated=!1,currentUser=null,authStatus.textContent=t,authStatus.style.color="#ef4444",loginBtn.hidden=!1,logoutBtn.hidden=!0,updateCommentFormState(),openAuthModal("login"),setTimeout(()=>{authStatus.style.color=""},3e3)}loginBtn.onclick=()=>openAuthModal("login"),authCloseBtn.onclick=closeAuthModal,modal.onclick=t=>{t.target===modal&&closeAuthModal()},authSwitchBtn.onclick=()=>{openAuthModal("login"===authMode?"register":"login")},authSubmitBtn.onclick=async()=>{const t=authUsername.value.trim(),e=authPassword.value;if(t&&e)if(t.length<3)authError.textContent="Username must be at least 3 characters";else if(e.length<8)authError.textContent="Password must be at least 8 characters";else{authSubmitBtn.disabled=!0,authSubmitBtn.textContent="Please wait...";try{const n="login"===authMode?"/api/auth/login":"/api/auth/register",o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})}),a=await o.json();if(!o.ok)return authError.style.color="#ef4444",void(authError.textContent=a.error||"Authentication failed");authError.style.color="#22c55e",authError.textContent="login"===authMode?"Signed in ðŸŽ¶":"Account created ðŸŽ‰",setTimeout(async()=>{closeAuthModal(),await checkAuth()},700)}catch(t){console.error("Auth error:",t),authError.style.color="#ef4444",authError.textContent="Network error. Please try again."}finally{authSubmitBtn.disabled=!1,authSubmitBtn.textContent="login"===authMode?"Sign In":"Sign Up"}}else authError.textContent="Missing username or password"},logoutBtn.onclick=async()=>{try{await fetch("/api/auth/logout",{method:"POST"}),await checkAuth()}catch(t){console.error("Logout error:",t),isAuthenticated=!1,currentUser=null,updateCommentFormState(),authStatus.textContent="Sign in to post comments",loginBtn.hidden=!1,logoutBtn.hidden=!0}},[titleInput,bodyInput].forEach(t=>{t.addEventListener("focus",()=>{isAuthenticated||(openAuthModal("login"),t.blur())})}),form.addEventListener("submit",async t=>{if(t.preventDefault(),!isAuthenticated)return void openAuthModal("login");const e=titleInput.value.trim(),n=bodyInput.value.trim();if(!e||!n)return void alert("Please fill in both title and body");if(e.length>128)return void alert("Title must be 128 characters or less");if(n.length>4e3)return void alert("Comment must be 4000 characters or less");const o=form.querySelector('button[type="submit"]'),a=o.textContent;o.disabled=!0,o.textContent="Posting...";try{const t=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,body:n})});if(401===t.status)return void handleSessionExpired();if(!t.ok){const e=await t.json();return void alert(e.error||"Failed to post comment")}titleInput.value="",bodyInput.value="",await loadComments(),window.scrollTo({top:0,behavior:"smooth"})}catch(t){console.error("Post comment error:",t),alert("Network error. Please try again.")}finally{o.disabled=!1,o.textContent=a}}),document.addEventListener("keydown",t=>{"Escape"!==t.key||modal.classList.contains("hidden")||closeAuthModal(),"Enter"!==t.key||modal.classList.contains("hidden")||t.target!==authUsername&&t.target!==authPassword||(t.preventDefault(),authSubmitBtn.click())}),checkAuth();