const form=document.getElementById("commentForm"),titleInput=document.getElementById("title"),bodyInput=document.getElementById("body"),commentsContainer=document.getElementById("comments"),loginBtn=document.getElementById("loginBtn"),logoutBtn=document.getElementById("logoutBtn"),authStatus=document.getElementById("authStatus"),modal=document.getElementById("authModal"),modalTitle=document.getElementById("authModalTitle"),authUsername=document.getElementById("authUsername"),authPassword=document.getElementById("authPassword"),authSubmitBtn=document.getElementById("authSubmitBtn"),authSwitchBtn=document.getElementById("authSwitchBtn"),authError=document.getElementById("authError"),authCloseBtn=document.getElementById("authCloseBtn");let isAuthenticated=!1,authMode="login",currentUser=null;async function checkAuth(){try{const t=await fetch("/api/auth/status");if(401===t.status)return void handleSessionExpired();const e=await t.json();isAuthenticated=!!e.authenticated,currentUser=e.user?.username||null,isAuthenticated?(authStatus.textContent=`Signed in as ${currentUser}`,loginBtn.hidden=!0,logoutBtn.hidden=!1):(authStatus.textContent="Sign in to post comments",loginBtn.hidden=!1,logoutBtn.hidden=!0),updateCommentFormState(),await loadComments()}catch(t){console.error("Auth check failed",t)}}function updateCommentFormState(){const t=!isAuthenticated;titleInput.disabled=t,bodyInput.disabled=t}function openAuthModal(t="login"){authMode=t,modal.classList.remove("hidden"),authError.textContent="",modalTitle.textContent="login"===t?"Sign In":"Create Account",authSwitchBtn.textContent="login"===t?"Need an account? Sign up":"Already have an account? Sign in"}function closeAuthModal(){modal.classList.add("hidden"),authUsername.value="",authPassword.value=""}async function loadComments(){commentsContainer.textContent="Loading comments...";try{const t=await fetch("/api/comments"),e=await t.json();if(commentsContainer.innerHTML="",!e.length)return void(commentsContainer.textContent="No comments yet.");e.forEach(renderComment)}catch{commentsContainer.textContent="Failed to load comments."}}function renderComment(t){const e=document.createElement("div");if(e.className="comment",e.innerHTML=`\n    <h4>${t.title}</h4>\n    <small>${t.username} â€¢ ${new Date(t.created_at).toLocaleDateString()}</small>\n    <p>${t.body}</p>\n  `,isAuthenticated&&t.username===currentUser){const n=document.createElement("button");n.textContent="Delete",n.className="comment-delete",n.onclick=async()=>{confirm("Delete your comment?")&&(await fetch(`/api/comments/${t.id}`,{method:"DELETE"}),401!==res.status?loadComments():handleSessionExpired())},e.appendChild(n)}commentsContainer.appendChild(e)}function handleSessionExpired(t="Your session expired. Please sign in again."){isAuthenticated=!1,currentUser=null,authStatus.textContent=t,loginBtn.hidden=!1,logoutBtn.hidden=!0,updateCommentFormState(),openAuthModal("login")}loginBtn.onclick=()=>openAuthModal("login"),authCloseBtn.onclick=closeAuthModal,authSwitchBtn.onclick=()=>{openAuthModal("login"===authMode?"register":"login")},authSubmitBtn.onclick=async()=>{const t=authUsername.value.trim(),e=authPassword.value;if(!t||!e)return void(authError.textContent="Missing username or password");const n="login"===authMode?"/api/auth/login":"/api/auth/register",o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})}),a=await o.json();o.ok?(authError.style.color="#22c55e",authError.textContent="login"===authMode?"Signed in ðŸŽ¶":"Account created ðŸŽ‰",setTimeout(async()=>{closeAuthModal(),await checkAuth()},700)):authError.textContent=a.error||"Auth failed"},logoutBtn.onclick=async()=>{await fetch("/api/auth/logout",{method:"POST"}),await checkAuth()},[titleInput,bodyInput].forEach(t=>{t.addEventListener("focus",()=>{isAuthenticated||(openAuthModal("login"),t.blur())})}),form.addEventListener("submit",async t=>{if(t.preventDefault(),!isAuthenticated)return void openAuthModal("login");const e=titleInput.value.trim(),n=bodyInput.value.trim();if(!e||!n)return;const o=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,body:n})});401!==o.status?o.ok&&(titleInput.value="",bodyInput.value="",loadComments()):handleSessionExpired()}),checkAuth();